<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Unbug Solutions TI</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/png" href="/img/logo_img.png">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="/img/logo_img.png" alt="Unbug Solutions TI">
                    <h1>Unbug Solutions TI - Admin</h1>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="/">In√≠cio</a></li>
                        <li><a href="/chamados">Abrir Chamado</a></li>
                        <li><a href="#" onclick="logout()" id="logout-link" style="display: none;">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- √Årea de Login -->
    <div id="loginArea" class="container-sm" style="padding: 80px 0;">
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <div class="card-header text-center">
                <h2>üîê Acesso Administrativo</h2>
            </div>
            <div class="card-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="password">Senha de Administrador:</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <span id="loginBtnText">Entrar</span>
                        <span id="loginLoading" class="loading d-none"></span>
                    </button>
                </form>
                <div id="loginError" class="mt-2"></div>
            </div>
        </div>
    </div>

    <!-- Painel Administrativo -->
    <div id="adminPanel" class="container" style="padding: 40px 0; display: none;">
        
        <!-- Estat√≠sticas -->
        <div class="card mb-4">
            <div class="card-header">
                <h2>üìä Estat√≠sticas Gerais</h2>
            </div>
            <div class="card-body">
                <div id="statsContent">
                    <div class="row text-center">
                        <div class="col-3">
                            <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold;" id="totalChamados">-</div>
                                <div>Total de Chamados</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold;" id="chamadosAbertos">-</div>
                                <div>Abertos</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold;" id="chamadosAndamento">-</div>
                                <div>Em Andamento</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold;" id="chamadosResolvidos">-</div>
                                <div>Resolvidos</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-3">
                        <label class="form-label">Filtrar por Status:</label>
                        <select id="filtroStatus" class="form-control form-select" onchange="aplicarFiltros()">
                            <option value="">Todos os status</option>
                            <option value="aberto">Aberto</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="aguardando_cliente">Aguardando Cliente</option>
                            <option value="resolvido">Resolvido</option>
                            <option value="fechado">Fechado</option>
                        </select>
                    </div>
                    <div class="col-3">
                        <label class="form-label">Filtrar por Urg√™ncia:</label>
                        <select id="filtroUrgencia" class="form-control form-select" onchange="aplicarFiltros()">
                            <option value="">Todas as urg√™ncias</option>
                            <option value="critica">Cr√≠tica</option>
                            <option value="alta">Alta</option>
                            <option value="media">M√©dia</option>
                            <option value="baixa">Baixa</option>
                        </select>
                    </div>
                    <div class="col-3">
                        <label class="form-label">Buscar:</label>
                        <input type="text" id="busca" class="form-control" placeholder="Nome, email ou empresa" onkeyup="aplicarFiltros()">
                    </div>
                    <div class="col-3">
                        <label class="form-label">&nbsp;</label>
                        <button onclick="carregarChamados()" class="btn btn-secondary btn-block">üîÑ Atualizar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Chamados -->
        <div class="card">
            <div class="card-header">
                <h2>üìã Gerenciar Chamados</h2>
            </div>
            <div class="card-body">
                <div id="chamadosContent">
                    <div class="text-center">
                        <div class="loading" style="width: 40px; height: 40px;"></div>
                        <p>Carregando chamados...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Chamado -->
    <div id="modalEditarChamado" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px;">
            <div class="card">
                <div class="card-header">
                    <h3>‚úèÔ∏è Editar Chamado #<span id="modalChamadoId"></span></h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Status:</label>
                        <select id="modalStatus" class="form-control form-select">
                            <option value="aberto">Aberto</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="aguardando_cliente">Aguardando Cliente</option>
                            <option value="resolvido">Resolvido</option>
                            <option value="fechado">Fechado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observa√ß√µes do Administrador:</label>
                        <textarea id="modalObservacoes" class="form-control" rows="4" placeholder="Adicione observa√ß√µes sobre o atendimento..."></textarea>
                    </div>
                </div>
                <div class="card-footer text-right">
                    <button onclick="fecharModal()" class="btn btn-secondary" style="margin-right: 10px;">Cancelar</button>
                    <button onclick="salvarChamado()" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Unbug Solutions TI. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="/js/app.js"></script>
    <script>
        let token = localStorage.getItem('adminToken');
        let todosChamados = [];
        let chamadosFiltrados = [];

        // Verificar se j√° est√° logado
        if (token) {
            verificarToken();
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const btnText = document.getElementById('loginBtnText');
            const btnLoading = document.getElementById('loginLoading');
            const loginError = document.getElementById('loginError');
            
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            loginError.innerHTML = '';
            
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    mostrarPainelAdmin();
                } else {
                    loginError.innerHTML = '<div class="alert alert-danger">Senha incorreta</div>';
                }
                
            } catch (error) {
                loginError.innerHTML = '<div class="alert alert-danger">Erro de conex√£o</div>';
            } finally {
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
            }
        });

        async function verificarToken() {
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    mostrarPainelAdmin();
                } else {
                    localStorage.removeItem('adminToken');
                    token = null;
                }
            } catch (error) {
                localStorage.removeItem('adminToken');
                token = null;
            }
        }

        function mostrarPainelAdmin() {
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('logout-link').style.display = 'block';
            carregarEstatisticas();
            carregarChamados();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            token = null;
            document.getElementById('loginArea').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('logout-link').style.display = 'none';
            document.getElementById('password').value = '';
        }

        async function carregarEstatisticas() {
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('totalChamados').textContent = stats.total_chamados;
                    document.getElementById('chamadosAbertos').textContent = stats.chamados_abertos;
                    document.getElementById('chamadosAndamento').textContent = stats.chamados_em_andamento;
                    document.getElementById('chamadosResolvidos').textContent = stats.chamados_resolvidos;
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        async function carregarChamados() {
            try {
                const response = await fetch('/api/admin/chamados', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    todosChamados = data.chamados;
                    aplicarFiltros();
                } else {
                    document.getElementById('chamadosContent').innerHTML = '<div class="alert alert-danger">Erro ao carregar chamados</div>';
                }
            } catch (error) {
                document.getElementById('chamadosContent').innerHTML = '<div class="alert alert-danger">Erro de conex√£o</div>';
            }
        }

        function aplicarFiltros() {
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroUrgencia = document.getElementById('filtroUrgencia').value;
            const busca = document.getElementById('busca').value.toLowerCase();
            
            chamadosFiltrados = todosChamados.filter(chamado => {
                const statusMatch = !filtroStatus || chamado.status === filtroStatus;
                const urgenciaMatch = !filtroUrgencia || chamado.urgencia === filtroUrgencia;
                const buscaMatch = !busca || 
                    chamado.nome.toLowerCase().includes(busca) ||
                    chamado.email.toLowerCase().includes(busca) ||
                    (chamado.empresa && chamado.empresa.toLowerCase().includes(busca));
                
                return statusMatch && urgenciaMatch && buscaMatch;
            });
            
            renderizarChamados();
        }

        function renderizarChamados() {
            const content = document.getElementById('chamadosContent');
            
            if (chamadosFiltrados.length === 0) {
                content.innerHTML = '<div class="alert alert-info">Nenhum chamado encontrado com os filtros aplicados.</div>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table">';
            html += `
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Empresa</th>
                        <th>Tipo</th>
                        <th>Urg√™ncia</th>
                        <th>Status</th>
                        <th>Data</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            chamadosFiltrados.forEach(chamado => {
                html += `
                    <tr>
                        <td><strong>#${chamado.id}</strong></td>
                        <td>
                            <div>${chamado.nome}</div>
                            <small style="color: #64748b;">${chamado.email}</small>
                        </td>
                        <td>${chamado.empresa || '-'}</td>
                        <td>${formatarTipoProblema(chamado.tipo_problema)}</td>
                        <td>${getUrgenciaBadge(chamado.urgencia)}</td>
                        <td>${getStatusBadge(chamado.status)}</td>
                        <td>${new Date(chamado.data_criacao).toLocaleDateString('pt-BR')}</td>
                        <td>
                            <button onclick="editarChamado(${chamado.id})" class="btn btn-primary" style="margin-right: 5px; padding: 5px 10px; font-size: 0.8rem;">‚úèÔ∏è Editar</button>
                            <button onclick="verDetalhes(${chamado.id})" class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px; font-size: 0.8rem;">üëÅÔ∏è Ver</button>
                            <button onclick="deletarChamado(${chamado.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;">üóëÔ∏è Excluir</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            content.innerHTML = html;
        }

        function formatarTipoProblema(tipo) {
            const tipos = {
                'hardware': 'Hardware',
                'software': 'Software',
                'rede': 'Rede',
                'email': 'E-mail',
                'backup': 'Backup',
                'seguranca': 'Seguran√ßa',
                'telefonia': 'Telefonia',
                'servidor': 'Servidor',
                'outros': 'Outros'
            };
            return tipos[tipo] || tipo;
        }

        function getStatusBadge(status) {
            const badges = {
                'aberto': '<span class="badge badge-danger">Aberto</span>',
                'em_andamento': '<span class="badge badge-warning">Em Andamento</span>',
                'aguardando_cliente': '<span class="badge badge-info">Aguardando Cliente</span>',
                'resolvido': '<span class="badge badge-success">Resolvido</span>',
                'fechado': '<span class="badge badge-secondary">Fechado</span>'
            };
            return badges[status] || '<span class="badge badge-secondary">Desconhecido</span>';
        }

        function getUrgenciaBadge(urgencia) {
            const badges = {
                'baixa': '<span class="badge badge-info">Baixa</span>',
                'media': '<span class="badge badge-warning">M√©dia</span>',
                'alta': '<span class="badge badge-danger">Alta</span>',
                'critica': '<span class="badge badge-danger">Cr√≠tica</span>'
            };
            return badges[urgencia] || '<span class="badge badge-secondary">M√©dia</span>';
        }

        function editarChamado(id) {
            const chamado = todosChamados.find(c => c.id === id);
            if (!chamado) return;
            
            document.getElementById('modalChamadoId').textContent = id;
            document.getElementById('modalStatus').value = chamado.status;
            document.getElementById('modalObservacoes').value = chamado.observacoes_admin || '';
            document.getElementById('modalEditarChamado').style.display = 'block';
        }

        function fecharModal() {
            document.getElementById('modalEditarChamado').style.display = 'none';
        }

        async function salvarChamado() {
            const id = document.getElementById('modalChamadoId').textContent;
            const status = document.getElementById('modalStatus').value;
            const observacoes = document.getElementById('modalObservacoes').value;
            
            try {
                const response = await fetch(`/api/admin/chamados/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status, observacoes_admin: observacoes })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    fecharModal();
                    carregarChamados();
                    carregarEstatisticas();
                    alert('Chamado atualizado com sucesso!');
                } else {
                    alert('Erro ao atualizar chamado: ' + data.error);
                }
                
            } catch (error) {
                alert('Erro de conex√£o');
            }
        }

        function verDetalhes(id) {
            const chamado = todosChamados.find(c => c.id === id);
            if (!chamado) return;
            
            let detalhes = `
CHAMADO #${chamado.id}

Cliente: ${chamado.nome}
E-mail: ${chamado.email}
Telefone: ${chamado.telefone || 'N√£o informado'}
Empresa: ${chamado.empresa || 'N√£o informado'}

Tipo: ${formatarTipoProblema(chamado.tipo_problema)}
Urg√™ncia: ${chamado.urgencia}
Status: ${chamado.status}

Descri√ß√£o:
${chamado.descricao}

Data de Cria√ß√£o: ${new Date(chamado.data_criacao).toLocaleString('pt-BR')}
${chamado.data_atualizacao ? '√öltima Atualiza√ß√£o: ' + new Date(chamado.data_atualizacao).toLocaleString('pt-BR') : ''}

${chamado.observacoes_admin ? 'Observa√ß√µes do Admin:\n' + chamado.observacoes_admin : 'Sem observa√ß√µes do administrador'}
            `;
            
            alert(detalhes);
        }

        async function deletarChamado(id) {
            if (!confirm('Tem certeza que deseja excluir este chamado? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/chamados/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    carregarChamados();
                    carregarEstatisticas();
                    alert('Chamado exclu√≠do com sucesso!');
                } else {
                    alert('Erro ao excluir chamado: ' + data.error);
                }
                
            } catch (error) {
                alert('Erro de conex√£o');
            }
        }

        // Fechar modal clicando fora
        document.getElementById('modalEditarChamado').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModal();
            }
        });

        // Tecla ESC para fechar modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharModal();
            }
        });
    </script>
</body>
</html>
